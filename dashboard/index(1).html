<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nanaka Farm Dashboard</title>

    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.5.0/dist/Recharts.js"></script>

    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            font-weight: 700;
        }

        .header .timestamp {
            color: #666;
            font-size: 14px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-value {
            color: #333;
            font-size: 36px;
            font-weight: 700;
        }

        .card-unit {
            color: #999;
            font-size: 18px;
            margin-left: 5px;
        }

        .card-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .map-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #map {
            height: 400px;
            border-radius: 8px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-healthy {
            background: #10b981;
            color: white;
        }

        .status-moderate {
            background: #f59e0b;
            color: white;
        }

        .status-poor {
            background: #ef4444;
            color: white;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #fcc;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

        // APIË®≠ÂÆö
        const API_BASE_URL = 'http://localhost:5000/api';
        const REFRESH_INTERVAL = 60000; // 1ÂàÜ„Åî„Å®„Å´„Éá„Éº„ÇøÊõ¥Êñ∞

        // API„ÇØ„É©„Ç§„Ç¢„É≥„Éà
        const api = {
            async fetchSummary() {
                const response = await fetch(`${API_BASE_URL}/summary`);
                if (!response.ok) throw new Error('Failed to fetch summary');
                return response.json();
            },
            async fetchNDVITrend(days = 7) {
                const response = await fetch(`${API_BASE_URL}/ndvi-trend?days=${days}`);
                if (!response.ok) throw new Error('Failed to fetch NDVI trend');
                return response.json();
            },
            async fetchWorkHours() {
                const response = await fetch(`${API_BASE_URL}/work-hours`);
                if (!response.ok) throw new Error('Failed to fetch work hours');
                return response.json();
            },
            async fetchFields() {
                const response = await fetch(`${API_BASE_URL}/fields`);
                if (!response.ok) throw new Error('Failed to fetch fields');
                return response.json();
            },
            async fetchAllData() {
                const [summary, ndviTrend, workHours, fields] = await Promise.all([
                    this.fetchSummary(),
                    this.fetchNDVITrend(),
                    this.fetchWorkHours(),
                    this.fetchFields()
                ]);
                return {
                    summary,
                    ndviTimeSeries: ndviTrend,
                    workHoursByField: workHours,
                    fields
                };
            }
        };

        // „Çµ„Éû„É™„Éº„Ç´„Éº„Éâ„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
        const SummaryCard = ({ icon, title, value, unit }) => (
            <div className="card">
                <div className="card-icon">{icon}</div>
                <div className="card-title">{title}</div>
                <div>
                    <span className="card-value">{value}</span>
                    <span className="card-unit">{unit}</span>
                </div>
            </div>
        );

        // NDVIÊôÇÁ≥ªÂàó„Ç∞„É©„Éï
        const NDVIChart = ({ data }) => (
            <div className="chart-card">
                <div className="chart-title">üìà NDVIÊôÇÁ≥ªÂàóÊé®Áßª</div>
                <ResponsiveContainer width="100%" height={300}>
                    <LineChart data={data}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="date" />
                        <YAxis domain={[0, 1]} />
                        <Tooltip />
                        <Legend />
                        <Line
                            type="monotone"
                            dataKey="ndvi"
                            stroke="#10b981"
                            strokeWidth={3}
                            name="NDVI"
                        />
                    </LineChart>
                </ResponsiveContainer>
            </div>
        );

        // ‰ΩúÊ•≠ÊôÇÈñìÊ£í„Ç∞„É©„Éï
        const WorkHoursChart = ({ data }) => (
            <div className="chart-card">
                <div className="chart-title">‚è±Ô∏è ÂúÉÂ†¥Âà•‰ΩúÊ•≠ÊôÇÈñì</div>
                <ResponsiveContainer width="100%" height={300}>
                    <BarChart data={data}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="field" />
                        <YAxis />
                        <Tooltip />
                        <Legend />
                        <Bar dataKey="hours" fill="#667eea" name="‰ΩúÊ•≠ÊôÇÈñìÔºàhÔºâ" />
                    </BarChart>
                </ResponsiveContainer>
            </div>
        );

        // Âú∞Âõ≥„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
        const FarmMap = ({ fields }) => {
            useEffect(() => {
                // Âú∞Âõ≥ÂàùÊúüÂåñ
                const map = L.map('map').setView([32.8032, 130.7075], 13);

                // OpenStreetMap„Çø„Ç§„É´
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);

                // ÂúÉÂ†¥„Éû„Éº„Ç´„ÉºËøΩÂä†
                fields.forEach(field => {
                    const statusColor = field.status === 'healthy' ? 'green' :
                                       field.status === 'moderate' ? 'orange' : 'red';

                    const marker = L.circleMarker([field.lat, field.lon], {
                        radius: 10,
                        fillColor: statusColor,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    marker.bindPopup(`
                        <div style="font-family: sans-serif;">
                            <h3 style="margin: 0 0 10px 0; color: #333;">${field.name}</h3>
                            <p style="margin: 5px 0;"><strong>Èù¢Á©ç:</strong> ${field.area.toLocaleString()} m¬≤</p>
                            <p style="margin: 5px 0;"><strong>NDVI:</strong> ${field.ndvi.toFixed(3)}</p>
                            <p style="margin: 5px 0;"><strong>Áä∂ÊÖã:</strong>
                                <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">
                                    ${field.status === 'healthy' ? 'ÂÅ•Â∫∑' : field.status === 'moderate' ? 'ÊôÆÈÄö' : 'Ê≥®ÊÑè'}
                                </span>
                            </p>
                        </div>
                    `);
                });

                // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                return () => {
                    map.remove();
                };
            }, [fields]);

            return (
                <div className="map-container">
                    <div className="chart-title">üó∫Ô∏è ÂúÉÂ†¥„Éû„ÉÉ„Éó</div>
                    <div id="map"></div>
                </div>
            );
        };

        // „É°„Ç§„É≥„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ
        const Dashboard = () => {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [lastUpdate, setLastUpdate] = useState(new Date());

            // „Éá„Éº„ÇøÂèñÂæóÈñ¢Êï∞
            const fetchData = async () => {
                try {
                    setError(null);
                    const newData = await api.fetchAllData();
                    setData(newData);
                    setLastUpdate(new Date());
                    setLoading(false);
                } catch (err) {
                    console.error('Error fetching data:', err);
                    setError(`„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº: ${err.message}`);
                    setLoading(false);
                }
            };

            useEffect(() => {
                // ÂàùÂõû„Éá„Éº„ÇøÂèñÂæó
                fetchData();

                // ÂÆöÊúüÁöÑ„Å´„Éá„Éº„ÇøÊõ¥Êñ∞
                const interval = setInterval(() => {
                    fetchData();
                }, REFRESH_INTERVAL);

                return () => clearInterval(interval);
            }, []);

            // „É≠„Éº„Éá„Ç£„É≥„Ç∞‰∏≠
            if (loading) {
                return (
                    <div className="dashboard">
                        <div className="loading">
                            ‚è≥ „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...
                        </div>
                    </div>
                );
            }

            // „Ç®„É©„ÉºÁô∫ÁîüÊôÇ
            if (error) {
                return (
                    <div className="dashboard">
                        <div className="error-message">
                            ‚ö†Ô∏è {error}
                            <br />
                            <button onClick={fetchData} style={{marginTop: '10px', padding: '8px 16px', cursor: 'pointer'}}>
                                ÂÜçË©¶Ë°å
                            </button>
                        </div>
                    </div>
                );
            }

            // „Éá„Éº„Çø„ÅåÂèñÂæó„Åß„Åç„Å™„ÅÑÂ†¥Âêà
            if (!data) {
                return (
                    <div className="dashboard">
                        <div className="error-message">
                            „Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                        </div>
                    </div>
                );
            }

            return (
                <div className="dashboard">
                    {/* „Éò„ÉÉ„ÉÄ„Éº */}
                    <div className="header">
                        <h1>üåæ Nanaka Farm Dashboard</h1>
                        <div className="timestamp">
                            ÊúÄÁµÇÊõ¥Êñ∞: {lastUpdate.toLocaleString('ja-JP')}
                            <button
                                onClick={fetchData}
                                style={{
                                    marginLeft: '15px',
                                    padding: '6px 12px',
                                    cursor: 'pointer',
                                    borderRadius: '6px',
                                    border: '1px solid #ddd',
                                    background: 'white'
                                }}
                            >
                                üîÑ Êõ¥Êñ∞
                            </button>
                        </div>
                    </div>

                    {/* „Çµ„Éû„É™„Éº„Ç´„Éº„Éâ */}
                    <div className="summary-cards">
                        <SummaryCard
                            icon="üè°"
                            title="Á∑èÂúÉÂ†¥Êï∞"
                            value={data.summary.totalFields}
                            unit="ÂúÉÂ†¥"
                        />
                        <SummaryCard
                            icon="üìè"
                            title="Á∑èÈù¢Á©ç"
                            value={(data.summary.totalArea / 10000).toFixed(1)}
                            unit="ha"
                        />
                        <SummaryCard
                            icon="‚è∞"
                            title="‰ªäÊúà„ÅÆ‰ΩúÊ•≠ÊôÇÈñì"
                            value={data.summary.monthlyWorkHours}
                            unit="ÊôÇÈñì"
                        />
                        <SummaryCard
                            icon="üåø"
                            title="Âπ≥ÂùáNDVI"
                            value={data.summary.avgNDVI.toFixed(3)}
                            unit=""
                        />
                    </div>

                    {/* „Ç∞„É©„Éï */}
                    <div className="charts-container">
                        <NDVIChart data={data.ndviTimeSeries} />
                        <WorkHoursChart data={data.workHoursByField} />
                    </div>

                    {/* Âú∞Âõ≥ */}
                    <FarmMap fields={data.fields} />
                </div>
            );
        };

        // „É¨„É≥„ÉÄ„É™„É≥„Ç∞
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
