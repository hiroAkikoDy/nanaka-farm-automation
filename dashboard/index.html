<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nanaka Farm Dashboard - Full Version</title>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            font-weight: 700;
        }

        .header .timestamp {
            color: #666;
            font-size: 14px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            text-align: center;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .card-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .card-title {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-value {
            color: #333;
            font-size: 36px;
            font-weight: 700;
        }

        .card-unit {
            color: #999;
            font-size: 18px;
            margin-left: 5px;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .chart-canvas {
            max-height: 300px;
        }

        .map-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #map {
            height: 400px;
            border-radius: 8px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-healthy {
            background: #10b981;
            color: white;
        }

        .success-message {
            background: #10b981;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <h1>ğŸŒ¾ Nanaka Farm Dashboard</h1>
            <div class="timestamp" id="timestamp"></div>
        </div>

        <!-- æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div class="success-message">
            âœ… Phase 8 å®Œäº†ï¼å®ŸAPIæ¥ç¶šæˆåŠŸãƒ»é«˜è§£åƒåº¦ãƒ‡ãƒ¼ã‚¿åé›†ä¸­
        </div>

        <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
        <div class="summary-cards">
            <div class="card">
                <div class="card-icon">ğŸ¡</div>
                <div class="card-title">ç·åœƒå ´æ•°</div>
                <div>
                    <span class="card-value">5</span>
                    <span class="card-unit">åœƒå ´</span>
                </div>
            </div>

            <div class="card">
                <div class="card-icon">ğŸ“</div>
                <div class="card-title">ç·é¢ç©</div>
                <div>
                    <span class="card-value">5.0</span>
                    <span class="card-unit">ha</span>
                </div>
            </div>

            <div class="card">
                <div class="card-icon">â°</div>
                <div class="card-title">ä»Šæœˆã®ä½œæ¥­æ™‚é–“</div>
                <div>
                    <span class="card-value">120</span>
                    <span class="card-unit">æ™‚é–“</span>
                </div>
            </div>

            <div class="card">
                <div class="card-icon">ğŸŒ¿</div>
                <div class="card-title">å¹³å‡NDVI</div>
                <div>
                    <span class="card-value">0.752</span>
                    <span class="card-unit"></span>
                </div>
            </div>
        </div>

        <!-- ã‚°ãƒ©ãƒ• -->
        <div class="charts-container">
            <!-- NDVIæ™‚ç³»åˆ—ã‚°ãƒ©ãƒ• -->
            <div class="chart-card">
                <div class="chart-title">ğŸ“ˆ NDVIæ™‚ç³»åˆ—æ¨ç§»</div>
                <canvas id="ndviChart" class="chart-canvas"></canvas>
            </div>

            <!-- ä½œæ¥­æ™‚é–“æ£’ã‚°ãƒ©ãƒ• -->
            <div class="chart-card">
                <div class="chart-title">â±ï¸ åœƒå ´åˆ¥ä½œæ¥­æ™‚é–“</div>
                <canvas id="workHoursChart" class="chart-canvas"></canvas>
            </div>
        </div>

        <!-- åœ°å›³ -->
        <div class="map-container">
            <div class="chart-title">ğŸ—ºï¸ åœƒå ´ãƒãƒƒãƒ—</div>
            <div id="map"></div>
        </div>
    </div>

    <script>
        // APIè¨­å®š
        const API_BASE_URL = 'http://localhost:5000/api';
        const REFRESH_INTERVAL = 60000; // 1åˆ†ã”ã¨ã«æ›´æ–°

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let ndviChart = null;
        let workHoursChart = null;
        let map = null;
        let marker = null;

        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ›´æ–°
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('timestamp').textContent =
                'æœ€çµ‚æ›´æ–°: ' + now.toLocaleString('ja-JP');
        }
        updateTimestamp();
        setInterval(updateTimestamp, 1000);

        // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
        const mockData = {
            ndvi: {
                labels: ['01/01', '01/02', '01/03', '01/04', '01/05', '01/06', '01/07', '01/08'],
                values: [0.68, 0.71, 0.69, 0.73, 0.76, 0.74, 0.78, 0.75]
            },
            workHours: {
                labels: ['åœƒå ´A', 'åœƒå ´B', 'åœƒå ´C', 'åœƒå ´D', 'åœƒå ´E'],
                values: [35, 28, 22, 20, 15]
            },
            summary: {
                totalFields: 5,
                totalArea: 50000,
                monthlyWorkHours: 120,
                avgNDVI: 0.752
            },
            fields: [{
                id: 1,
                name: 'Nanaka Farm',
                lat: 32.8032,
                lon: 130.7075,
                area: 50000,
                ndvi: 0.752,
                status: 'healthy'
            }]
        };

        // APIå‘¼ã³å‡ºã—é–¢æ•°
        async function fetchWithFallback(endpoint, fallbackData) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return { data: await response.json(), source: 'api' };
            } catch (error) {
                console.warn(`API error for ${endpoint}:`, error.message, '- Using mock data');
                return { data: fallbackData, source: 'mock' };
            }
        }

        // ãƒ‡ãƒ¼ã‚¿å–å¾—
        async function fetchAllData() {
            const [summary, ndviTrend, workHours, fields] = await Promise.all([
                fetchWithFallback('/summary', mockData.summary),
                fetchWithFallback('/ndvi-trend?days=8', mockData.ndvi.labels.map((label, i) => ({
                    date: label,
                    ndvi: mockData.ndvi.values[i]
                }))),
                fetchWithFallback('/work-hours', mockData.workHours.labels.map((label, i) => ({
                    field: label,
                    hours: mockData.workHours.values[i]
                }))),
                fetchWithFallback('/fields', mockData.fields)
            ]);

            return {
                summary: summary.data,
                ndviTrend: ndviTrend.data,
                workHours: workHours.data,
                fields: fields.data,
                sources: {
                    summary: summary.source,
                    ndviTrend: ndviTrend.source,
                    workHours: workHours.source,
                    fields: fields.source
                }
            };
        }

        // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰æ›´æ–°
        function updateSummaryCards(summary) {
            const cards = document.querySelectorAll('.card');
            if (cards[0]) {
                cards[0].querySelector('.card-value').textContent = summary.totalFields || 0;
            }
            if (cards[1]) {
                cards[1].querySelector('.card-value').textContent =
                    ((summary.totalArea || 0) / 10000).toFixed(1);
            }
            if (cards[2]) {
                cards[2].querySelector('.card-value').textContent = summary.monthlyWorkHours || 0;
            }
            if (cards[3]) {
                cards[3].querySelector('.card-value').textContent =
                    (summary.avgNDVI || 0).toFixed(3);
            }
        }

        // NDVIã‚°ãƒ©ãƒ•æ›´æ–°é–¢æ•°
        function updateNDVIChart(ndviTrend) {
            const labels = ndviTrend.map(item => item.date);
            const values = ndviTrend.map(item => item.ndvi);

            if (ndviChart) {
                ndviChart.data.labels = labels;
                ndviChart.data.datasets[0].data = values;
                ndviChart.update();
            } else {
                const ndviCtx = document.getElementById('ndviChart').getContext('2d');
                ndviChart = new Chart(ndviCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'NDVI',
                            data: values,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 0.6,
                                max: 0.8,
                                ticks: {
                                    callback: function(value) {
                                        return value.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // ä½œæ¥­æ™‚é–“ã‚°ãƒ©ãƒ•æ›´æ–°é–¢æ•°
        function updateWorkHoursChart(workHours) {
            const labels = workHours.map(item => item.field);
            const values = workHours.map(item => item.hours);

            if (workHoursChart) {
                workHoursChart.data.labels = labels;
                workHoursChart.data.datasets[0].data = values;
                workHoursChart.update();
            } else {
                const workHoursCtx = document.getElementById('workHoursChart').getContext('2d');
                workHoursChart = new Chart(workHoursCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ä½œæ¥­æ™‚é–“ (h)',
                            data: values,
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.8)',
                                'rgba(118, 75, 162, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(239, 68, 68, 0.8)'
                            ],
                            borderColor: [
                                'rgb(102, 126, 234)',
                                'rgb(118, 75, 162)',
                                'rgb(16, 185, 129)',
                                'rgb(245, 158, 11)',
                                'rgb(239, 68, 68)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        // åœ°å›³æ›´æ–°é–¢æ•°
        function updateMap(fields) {
            if (!map) {
                map = L.map('map').setView([32.8032, 130.7075], 13);

                // OpenStreetMapã‚¿ã‚¤ãƒ«
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);
            }

            // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (marker) {
                map.removeLayer(marker);
            }

            // åœƒå ´ã”ã¨ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
            fields.forEach(field => {
                const statusColor = field.status === 'healthy' ? '#10b981' :
                                  field.status === 'moderate' ? '#f59e0b' : '#ef4444';
                const statusText = field.status === 'healthy' ? 'å¥åº·' :
                                 field.status === 'moderate' ? 'æ™®é€š' : 'æ³¨æ„';

                marker = L.circleMarker([field.lat, field.lon], {
                    radius: 15,
                    fillColor: statusColor,
                    color: '#fff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                marker.bindPopup(`
                    <div style="font-family: sans-serif; min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; color: #333;">ğŸŒ¾ ${field.name}</h3>
                        <p style="margin: 5px 0;"><strong>é¢ç©:</strong> ${field.area.toLocaleString()} mÂ²</p>
                        <p style="margin: 5px 0;"><strong>NDVI:</strong> ${field.ndvi.toFixed(3)}</p>
                        <p style="margin: 5px 0;"><strong>åº§æ¨™:</strong> ${field.lat.toFixed(4)}Â°N, ${field.lon.toFixed(4)}Â°E</p>
                        <p style="margin: 5px 0;">
                            <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                ${statusText}
                            </span>
                        </p>
                    </div>
                `);
            });
        }

        // ãƒ¡ã‚¤ãƒ³ã®åˆæœŸåŒ–ãƒ»æ›´æ–°é–¢æ•°
        async function initializeDashboard() {
            console.log('ğŸš€ Dashboard initializing...');

            try {
                const data = await fetchAllData();

                // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ãƒ­ã‚°å‡ºåŠ›
                console.log('ğŸ“Š Data sources:', data.sources);

                // å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æ›´æ–°
                updateSummaryCards(data.summary);
                updateNDVIChart(data.ndviTrend);
                updateWorkHoursChart(data.workHours);
                updateMap(data.fields);

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
                const apiConnected = Object.values(data.sources).some(s => s === 'api');
                const successMsg = document.querySelector('.success-message');
                if (apiConnected) {
                    successMsg.textContent = 'âœ… APIæ¥ç¶šæˆåŠŸï¼Neo4jã‹ã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­';
                    successMsg.style.background = '#10b981';
                } else {
                    successMsg.textContent = 'âš ï¸ APIæ¥ç¶šå¤±æ•— - ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­ï¼ˆAPIã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ãã ã•ã„ï¼‰';
                    successMsg.style.background = '#f59e0b';
                }

                console.log('âœ… Dashboard loaded successfully');
            } catch (error) {
                console.error('âŒ Dashboard initialization error:', error);
            }
        }

        // ã‚«ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function animateCards() {
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';

                setTimeout(() => {
                    card.style.transition = 'all 0.5s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });

            // ã‚°ãƒ©ãƒ•ã‚«ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            const chartCards = document.querySelectorAll('.chart-card, .map-container');
            chartCards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';

                setTimeout(() => {
                    card.style.transition = 'all 0.5s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 400 + index * 150);
            });
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        window.addEventListener('DOMContentLoaded', () => {
            animateCards();
            initializeDashboard();

            // å®šæœŸæ›´æ–°ï¼ˆ60ç§’ã”ã¨ï¼‰
            setInterval(() => {
                console.log('ğŸ”„ Refreshing dashboard data...');
                initializeDashboard();
            }, REFRESH_INTERVAL);
        });
    </script>
</body>
</html>
